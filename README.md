# MEDUSSA (MEmbrane DeconvolUtion and Segmentation for Size Analyses)
Repository to access the different notebooks and information of the paper "High-precision bacterial size profiling: dissecting mechanisms of cell-size diversity in *Priestia megaterium*"

Here you'll find the information of the different environments used for specific tasks (data plotting, restoration, segmentation)

The `.yml` files are directly exported from conda environments used in the study,which were used in a HPC computing cluster, and are found in the respective folder of the task they're used for.

Unless stated otherwise, figures were assembled using [Inkscape v1.4](https://inkscape.org/)

## MEDUSSA
A set of functions to measure rod-shaped cells from segmentation masks, estimate parameters to transform the data to account for segmentation error propagation, and sample data distributions. 

- `measure.py`: functions that calculate cell size measurement images of segmentation masks in cell size measurements: Length, Width, Surface Area, and Volume
- `transform.py`: functions that allow to transform the obtained metrics either by sampling parameters from a linear relationship to calculating confidence intervals
- `utils.py`: functions for changing segmentation labels, removing truncated edge masks, and calculating distribution intersections
- `requirements.txt`: minimum software requirements to run the functions in both `measure.py` and `transform.py` 
- `MEDUSSA_example.ipynb`: example notebook on how to load `MEDUSSA` and run the whole pipeline of deconvolution, segmentation, and measurement
  
## CARE 
The environment and notebooks to train the deconvolution prediction models outlined in the manuscript (refer to Figure 3 to see the results). Please refer to the [CSBDeep documentation](https://github.com/CSBDeep/CSBDeep) for installation instructions

- `care.yml`: conda environment file with the software specifications when training and segmenting
 
### The following notebooks are adapted from the official [CSBDeep repository](https://github.com/CSBDeep/CSBDeep)
- `Preparation.ipynb`: transforming the data into patches and exporting them into .npz files for training
- `Train.ipynb`: model training with the same parameters of the one used in the paper. GPU **very** necessary
- `Predict.ipynb`: notebook showing how to load a trained model and use it on new data

Training images can be found in:

## Omnipose
The environment and command train the segmentation models outlined in the manuscript (refer to Figure 2 and Supplementary Figure 2 to see the results). Please refer to the [Omnipose documentation](https://omnipose.readthedocs.io/) for installation instructions

- `omnipose_GPU.yml`: conda environment file with the software specifications for using with GPUs. This environment was used for model training, and can also be used for segmentation.
- `Omnipose_CLI.txt`: the command used to train the Omnipose segmentation model, including specifications of hardware. GPU **very** necessary
- `Omnipose_segmentation.ipynb`: Jupyter notebook exemplifying how to load a custom model and running it

Images (training and testing images and masks) can be found in:

## Figure reproducibility

In the "Figures" folder, you'll find each element necessary to reproduce the figures from the paper, where each figure has a corresponding folder. Inside the folders, you can find:
- Jupyter notebooks for reproducing graphs and plots
- Data tables (in `.csv` or `.xlsx` format) that are either: generated by the corresponding notebook in the folder, or generated externally but read by the figure's notebook
- Images (in `.png` or `.tif` format) to assemble pictures
- If image data needs to be downloaded, there will be a `wget` cell in the corresponding notebook

### References

- [Main article]() Reyes-Matte, M., Fortmann-Grote, C., Gericke, B., Hüttman, N., Ojkic, N., & Lopez-Garrido, J. (2025). Deep-learning-based segmentation of fluorescent membranes for high precision cell size studies in bacteria
- [CARE](https://www.nature.com/articles/s41592-018-0216-7) Weigert, M., Schmidt, U., Boothe, T., Müller, A., Dibrov, A., Jain, A., ... & Myers, E. W. (2018). Content-aware image restoration: pushing the limits of fluorescence microscopy. _Nature methods_, 15(12), 1090-1097.
- [Omnipose](https://www.nature.com/articles/s41592-022-01639-4) Cutler, K. J., Stringer, C., Lo, T. W., Rappez, L., Stroustrup, N., Brook Peterson, S., … & Mougous, J. D. (2022). Omnipose: a high-precision morphology-independent solution for bacterial cell segmentation. _Nature methods_, 19(11), 1438-1448.

